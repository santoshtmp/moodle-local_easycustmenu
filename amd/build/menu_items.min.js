define("local_easycustmenu/menu_items",["exports","jquery","core/sortable_list","core/ajax","core/str"],(function(_exports,_jquery,_sortable_list,_ajax,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * AMD ES6 module
   *
   * @copyright  2025 https://santoshmagar.com.np/
   * @author     santoshtmp7 https://github.com/santoshtmp/moodle-local_easycustmenu
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   *
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.menuItemReorder=_exports.contextRoleFilter=void 0,_jquery=_interopRequireDefault(_jquery),_sortable_list=_interopRequireDefault(_sortable_list),_ajax=_interopRequireDefault(_ajax);var elementSelector="";_exports.menuItemReorder=tableid=>{elementSelector="#"+tableid+' tbody[data-action="reorder"]';const childArrow=document.querySelector(".page-easycustmenu #depth-reusable-icon #child_arrow").innerHTML,childIndentation=document.querySelector(".page-easycustmenu #depth-reusable-icon #child_indentation").innerHTML;new _sortable_list.default(elementSelector,{targetListSelector:null,moveHandlerSelector:"[data-drag-type=move]",isHorizontal:!1,autoScroll:!0}),(0,_jquery.default)(elementSelector).on("click","[data-drag-type=move]",(function(e){return e.preventDefault(),e.stopPropagation(),!1})),(0,_jquery.default)(elementSelector).on("mousedown","[data-drag-type=move]",(function(e){let tr=(0,_jquery.default)(this).closest("tr"),depth0Rows=(0,_jquery.default)(elementSelector+' tr[data-depth="0"]');if(tr.is(depth0Rows.first())){let hasOtherDepth0=depth0Rows.length>1,nextRowDepth=parseInt(tr.next().attr("data-depth"))||0;if(!hasOtherDepth0||nextRowDepth>0)return e.preventDefault(),e.stopImmediatePropagation(),!1}})),(0,_jquery.default)(elementSelector).on(_sortable_list.default.EVENTS.DROP,(async function(evt,info){if("navmenu-table"==tableid){let element=info.element,endX=info.endX,startX=info.startX,positionChanged=info.positionChanged,itemDepth=parseInt(element.attr("data-depth"))||0,newItemDepth=itemDepth,prevElement=element.prev(),prevElementDepth=parseInt(prevElement.attr("data-depth"))||0;if(positionChanged){let elementIndex=(0,_jquery.default)(elementSelector+" tr").index(element),targetNextElementDepth=parseInt(info.targetNextElement.attr("data-depth"))||0;newItemDepth=0==elementIndex?0:Math.max(prevElementDepth,targetNextElementDepth)}else prevElement.length&&(endX>startX+30?newItemDepth=Math.min(itemDepth+1,prevElementDepth+1):endX<startX-30&&(newItemDepth=Math.max(0,itemDepth-1)));if(newItemDepth!==itemDepth){element.attr("data-depth",newItemDepth);let childIndentationIcon="";if(newItemDepth){for(let index=0;index<newItemDepth-1;index++)childIndentationIcon+=childIndentation;childIndentationIcon+=childArrow}let indentation=element.find(".child-icon-wrapper");indentation&&indentation.html(childIndentationIcon)}}(0,_jquery.default)("#save_menu_reorder").show()})),(0,_jquery.default)("#save_menu_reorder").on("click",(async function(){(0,_jquery.default)(this).prop("disabled",!0);let reorderItems=function(){let reorderItems={},depthStack={},parent=0;return(0,_jquery.default)(elementSelector+" tr").each((function(index){let id=parseInt((0,_jquery.default)(this).attr("data-id")),depth=parseInt((0,_jquery.default)(this).attr("data-depth"))||0;depth>0?parent=depthStack[depth-1]||0:(depthStack={},parent=0),depthStack[depth]=id,(0,_jquery.default)(this).attr("data-parent",parent),reorderItems[id]={menu_order:index,id:id,depth:depth,parent:parent}})),reorderItems}();Object.values(reorderItems).forEach((function(item){let tr=(0,_jquery.default)(elementSelector+' tr[data-id="'+item.id+'"]');tr&&(tr.attr("data-depth",item.depth),tr.attr("data-parent",item.parent),tr.attr("data-menu_order",item.menu_order))})),await async function(){let invalidRows=[];return(0,_jquery.default)(elementSelector+" tr").removeClass("invalid-depth").css("background-color",""),(0,_jquery.default)("#menu_depth_error").remove(),(0,_jquery.default)(elementSelector+" tr").each((function(){let depth=parseInt((0,_jquery.default)(this).attr("data-depth"))||0,parentId=parseInt((0,_jquery.default)(this).attr("data-parent")),parentDepth=(0,_jquery.default)(elementSelector+' tr[data-id="'+parentId+'"]').attr("data-depth")||0;Math.abs(depth-parseInt(parentDepth))>1&&invalidRows.push((0,_jquery.default)(this))})),invalidRows.length>0?(invalidRows.forEach((function(row){row.addClass("invalid-depth").css("background-color","#ffcccc")})),(0,_jquery.default)("#save_menu_reorder").prop("disabled",!0),(0,_jquery.default)('<div id="menu_depth_error" style="color:red;margin-top:10px;">'+await(0,_str.getString)("invalidmenudepth","local_easycustmenu")+"</div>").insertAfter((0,_jquery.default)("#save_menu_reorder"))):(0,_jquery.default)("#save_menu_reorder").prop("disabled",!1),invalidRows.length}()?(0,_jquery.default)(this).prop("disabled",!1):await async function(reorderItems){const request={methodname:"local_easycustmenu_save_menu_order",args:{items:reorderItems}};return await _ajax.default.call([request])[0].done((function(response){response.status?window.location.reload():window.console.log("Error saving menu order:",response.message)})).fail((function(){window.console.log("request failed.")})).always((function(){(0,_jquery.default)("#save_menu_reorder").prop("disabled",!1)}))}(reorderItems)}))};_exports.contextRoleFilter=rolesByContext=>{const contextSelect=document.querySelector('select[name="context_level"]'),roleSelect=document.querySelector('select[name="condition_roleid"]');contextSelect&&roleSelect&&contextSelect.addEventListener("change",(()=>{const ctxValue=contextSelect.value,roleList=rolesByContext[ctxValue]||[],previouslySelected=roleSelect.value;roleSelect.innerHTML="",roleList.forEach((_ref=>{let{value:value,label:label}=_ref;const opt=document.createElement("option");opt.value=value,opt.textContent=label,value===previouslySelected&&(opt.selected=!0),roleSelect.appendChild(opt)}))}))}}));

//# sourceMappingURL=menu_items.min.js.map