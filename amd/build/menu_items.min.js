define("local_easycustmenu/menu_items",["exports","jquery","core/sortable_list","core/ajax","core/str"],(function(_exports,_jquery,_sortable_list,_ajax,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * AMD ES6 module
   *
   * @copyright  2025 https://santoshmagar.com.np/
   * @author     santoshtmp7 https://github.com/santoshtmp/moodle-local_easycustmenu
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   *
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.menu_item_reorder=void 0,_jquery=_interopRequireDefault(_jquery),_sortable_list=_interopRequireDefault(_sortable_list),_ajax=_interopRequireDefault(_ajax);let elementSelector="";_exports.menu_item_reorder=tableid=>{elementSelector="#"+tableid+' tbody[data-action="reorder"]';let child_arrow=document.querySelector("#depth-reusable-icon #child_arrow").innerHTML,child_indentation=document.querySelector("#depth-reusable-icon #child_indentation").innerHTML;new _sortable_list.default(elementSelector,{targetListSelector:null,moveHandlerSelector:"[data-drag-type=move]",isHorizontal:!1,autoScroll:!0,canMove:element=>{let depth=parseInt(element.attr("data-depth"))||0,isFirst=element.is((0,_jquery.default)(elementSelector+" tr").first());return 0!==depth||!isFirst}}),(0,_jquery.default)(elementSelector).on("click","[data-drag-type=move]",(function(e){return e.preventDefault(),e.stopPropagation(),!1})),(0,_jquery.default)(elementSelector).on("mousedown","[data-drag-type=move]",(function(e){let tr=(0,_jquery.default)(this).closest("tr"),depth0Rows=(0,_jquery.default)(elementSelector+' tr[data-depth="0"]');if(tr.is(depth0Rows.first())){let hasOtherDepth0=depth0Rows.length>1,nextRowDepth=parseInt(tr.next().attr("data-depth"))||0;if(!hasOtherDepth0||nextRowDepth>0)return e.preventDefault(),e.stopImmediatePropagation(),!1}})),(0,_jquery.default)(elementSelector).on(_sortable_list.default.EVENTS.DROP,(async function(evt,info){let element=info.element,end_x=info.endX,start_x=info.startX,positionChanged=info.positionChanged,itemDepth=parseInt(element.attr("data-depth"))||0,new_itemDepth=itemDepth,prevElement=element.prev(),prevElementDepth=parseInt(prevElement.attr("data-depth"))||0;if(positionChanged){let elementIndex=(0,_jquery.default)(elementSelector+" tr").index(element),targetNextElementDepth=parseInt(info.targetNextElement.attr("data-depth"))||0;new_itemDepth=0==elementIndex?0:Math.max(prevElementDepth,targetNextElementDepth)}else prevElement.length&&(end_x>start_x+30?new_itemDepth=Math.min(itemDepth+1,prevElementDepth+1):end_x<start_x-30&&(new_itemDepth=Math.max(0,itemDepth-1)));if(new_itemDepth!==itemDepth){element.attr("data-depth",new_itemDepth);let child_indentation_icon="";if(new_itemDepth){for(let index=0;index<new_itemDepth-1;index++)child_indentation_icon+=child_indentation;child_indentation_icon+=child_arrow}let indentation=element.find(".child-icon-wrapper");indentation&&indentation.html(child_indentation_icon)}(0,_jquery.default)("#save_menu_reorder").show()})),(0,_jquery.default)("#save_menu_reorder").on("click",(async function(){(0,_jquery.default)(this).prop("disabled",!0);let reorder_items=function(){let reorder_items={},depthStack={};return(0,_jquery.default)(elementSelector+" tr").each((function(index){let id=parseInt((0,_jquery.default)(this).attr("data-id")),depth=parseInt((0,_jquery.default)(this).attr("data-depth"));depthStack[depth]=id;let parent=0;depth>0&&(parent=depthStack[depth-1]||0),(0,_jquery.default)(this).attr("data-parent",parent),reorder_items[id]={menu_order:index,id:id,depth:depth,parent:parent}})),reorder_items}();Object.values(reorder_items).forEach((function(item){let tr=(0,_jquery.default)(elementSelector+' tr[data-id="'+item.id+'"]');tr&&(tr.attr("data-depth",item.depth),tr.attr("data-parent",item.parent),tr.attr("data-menu_order",item.menu_order))})),await async function(){let invalidRows=[];return(0,_jquery.default)(elementSelector+" tr").removeClass("invalid-depth").css("background-color",""),(0,_jquery.default)("#menu_depth_error").remove(),(0,_jquery.default)(elementSelector+" tr").each((function(){let depth=parseInt((0,_jquery.default)(this).attr("data-depth"))||0,parent_id=parseInt((0,_jquery.default)(this).attr("data-parent")),parent_depth=(0,_jquery.default)(elementSelector+' tr[data-id="'+parent_id+'"]').attr("data-depth")||0;Math.abs(depth-parseInt(parent_depth))>1&&invalidRows.push((0,_jquery.default)(this))})),invalidRows.length>0?(invalidRows.forEach((function(row){row.addClass("invalid-depth").css("background-color","#ffcccc")})),(0,_jquery.default)("#save_menu_reorder").prop("disabled",!0),(0,_jquery.default)('<div id="menu_depth_error" style="color:red;margin-top:10px;">'+await(0,_str.getString)("invalidmenudepth","local_easycustmenu")+"</div>").insertAfter((0,_jquery.default)("#save_menu_reorder"))):(0,_jquery.default)("#save_menu_reorder").prop("disabled",!1),invalidRows.length}()?(0,_jquery.default)(this).prop("disabled",!1):await async function(reorder_items){const request={methodname:"local_easycustmenu_save_menu_order",args:{items:reorder_items}};return await _ajax.default.call([request])[0].done((function(response){response.status?(0,_jquery.default)("#save_menu_reorder").hide():window.console.log("Error saving menu order:",response.message)})).fail((function(){window.console.log("request failed.")})).always((function(){(0,_jquery.default)("#save_menu_reorder").prop("disabled",!1)}))}(reorder_items)}))}}));

//# sourceMappingURL=menu_items.min.js.map