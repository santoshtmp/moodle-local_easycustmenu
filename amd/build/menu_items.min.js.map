{"version":3,"file":"menu_items.min.js","sources":["../src/menu_items.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD ES6 module\n *\n * @copyright  2025 https://santoshmagar.com.np/\n * @author     santoshtmp7 https://github.com/santoshtmp/moodle-local_easycustmenu\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n *\n */\n\nimport $ from 'jquery';\nimport SortableList from 'core/sortable_list';\nimport Ajax from 'core/ajax';\nimport { getString } from 'core/str';\n\n/**\n * Variables define\n */\nvar elementSelector = '';\nconst moveHandlerSelector = '[data-drag-type=move]';\n\n\n/**\n * To check menu items siglings tr depths\n */\nasync function checkInvalidDepth() {\n    let invalidRows = [];\n    $(elementSelector + ' tr').removeClass('invalid-depth').css('background-color', '');\n    $('#menu_depth_error').remove();\n\n    // Check on each tr\n    $(elementSelector + ' tr').each(function () {\n        let depth = parseInt($(this).attr('data-depth')) || 0;\n        let parentId = parseInt($(this).attr('data-parent'));\n        let parentDepth = $(elementSelector + ' tr[data-id=\"' + parentId + '\"]').attr('data-depth') || 0;\n        if (Math.abs(depth - parseInt(parentDepth)) > 1) {\n            invalidRows.push($(this));\n        }\n    });\n\n    // Check invalid length\n    if (invalidRows.length > 0) {\n        invalidRows.forEach(function (row) {\n            row.addClass('invalid-depth').css('background-color', '#ffcccc');\n        });\n        $('#save_menu_reorder').prop('disabled', true);\n        $('<div id=\"menu_depth_error\" style=\"color:red;margin-top:10px;\">' +\n            await getString('invalidmenudepth', 'local_easycustmenu') + '</div>')\n            .insertAfter($('#save_menu_reorder'));\n    } else {\n        $('#save_menu_reorder').prop('disabled', false);\n    }\n\n    return invalidRows.length;\n}\n\n/**\n * To save the menu items\n * @param {*} reorderItems\n */\nasync function ajaxSaveMenuItems(reorderItems) {\n    // AJAX request to save the order\n    const request = {\n        methodname: 'local_easycustmenu_save_menu_order',\n        args: {\n            items: reorderItems,\n        }\n    };\n    return await Ajax.call([request])[0]\n        .done(function (response) {\n            if (response.status) {\n                window.location.reload();\n            } else {\n                window.console.log('Error saving menu order:', response.message);\n            }\n        }).fail(function () {\n            window.console.log('request failed.');\n        }).always(function () {\n            $('#save_menu_reorder').prop('disabled', false);\n        }\n        );\n}\n\n/**\n * Get reorder items\n */\nfunction getReorderItems() {\n    let reorderItems = {};\n    let depthStack = {}; // Stores the last seen ID for each depth level\n    let parent = 0;\n    $(elementSelector + ' tr').each(function (index) {\n        let id = parseInt($(this).attr('data-id'));\n        let depth = parseInt($(this).attr('data-depth')) || 0;\n        // Determine parent\n        if (depth > 0) {\n            parent = depthStack[depth - 1] || 0;\n        } else {\n            depthStack = {};\n            parent = 0;\n        }\n        // Store the last seen item at this depth\n        depthStack[depth] = id;\n        //\n        $(this).attr('data-parent', parent);\n        reorderItems[id] = {\n            menuorder: index,\n            id: id,\n            depth: depth,\n            parent: parent,\n        };\n\n    });\n    return reorderItems;\n}\n\n/**\n * Menu Item Re-order\n *\n * @param {*} tableid\n */\nexport const menuItemReorder = (tableid) => {\n    elementSelector = '#' + tableid + ' tbody[data-action=\"reorder\"]';\n    const childArrow = document.querySelector('.page-easycustmenu #depth-reusable-icon #child_arrow').innerHTML;\n    const childIndentation = document.querySelector('.page-easycustmenu #depth-reusable-icon #child_indentation').innerHTML;\n\n    // Initialise SortableList for drag-and-drop.\n    new SortableList(\n        elementSelector,\n        {\n            targetListSelector: null,\n            moveHandlerSelector: moveHandlerSelector,\n            isHorizontal: false,\n            autoScroll: true\n        }\n    );\n\n    // Disable click on drag handle to prevent unintended clicks\n    $(elementSelector).on('click', moveHandlerSelector, function (e) {\n        e.preventDefault();\n        e.stopPropagation();\n        return false;\n    });\n\n    // Prevent dragging start for first depth 0\n    $(elementSelector).on('mousedown', moveHandlerSelector, function (e) {\n        let tr = $(this).closest('tr');\n\n        // Find all depth 0 rows\n        let depth0Rows = $(elementSelector + ' tr[data-depth=\"0\"]');\n\n        // Check if this is the first depth 0 row\n        let isFirstDepth0 = tr.is(depth0Rows.first());\n\n        if (isFirstDepth0) {\n            let hasOtherDepth0 = depth0Rows.length > 1;\n            let nextRowDepth = parseInt(tr.next().attr('data-depth')) || 0;\n\n            // Condition: no other depth 0 row OR next sibling has depth > 0\n            if (!hasOtherDepth0 || nextRowDepth > 0) {\n                e.preventDefault();\n                e.stopImmediatePropagation();\n                return false;\n            }\n        }\n        return true;\n    });\n\n    // Handle drag-and-drop depth changes.\n    $(elementSelector).on(SortableList.EVENTS.DROP, async function (evt, info) {\n        if (tableid == 'navmenu-table') {\n            let element = info.element;\n            let endX = info.endX;\n            let startX = info.startX;\n            let positionChanged = info.positionChanged;\n            let itemDepth = parseInt(element.attr('data-depth')) || 0;\n            let newItemDepth = itemDepth;\n            let prevElement = element.prev();\n            let prevElementDepth = parseInt(prevElement.attr('data-depth')) || 0;\n\n            // Only adjust depth for significant horizontal movement\n            if (positionChanged) {\n                let elementIndex = $(elementSelector + ' tr').index(element);\n                let targetNextElementDepth = parseInt(info.targetNextElement.attr('data-depth')) || 0;\n                newItemDepth = (elementIndex == 0) ? 0 : Math.max(prevElementDepth, targetNextElementDepth);\n            } else {\n                if (prevElement.length) {\n                    if (endX > startX + 30) {\n                        newItemDepth = Math.min(itemDepth + 1, prevElementDepth + 1);\n                    } else if (endX < startX - 30) {\n                        newItemDepth = Math.max(0, itemDepth - 1);\n                    }\n                }\n            }\n\n            // Update element depth and child-icon only if depth changed\n            if (newItemDepth !== itemDepth) {\n                element.attr('data-depth', newItemDepth);\n                let childIndentationIcon = '';\n                if (newItemDepth) {\n                    for (let index = 0; index < newItemDepth - 1; index++) {\n                        childIndentationIcon += childIndentation;\n                    }\n                    childIndentationIcon += childArrow;\n                }\n                let indentation = element.find('.child-icon-wrapper');\n                if (indentation) {\n                    indentation.html(childIndentationIcon);\n                }\n\n            }\n        }\n        // Show save button after reordering\n        $('#save_menu_reorder').show();\n\n    });\n\n    // Save the order of menu items\n    $('#save_menu_reorder').on('click', async function () {\n        // Disable to prevent multiple clicks\n        $(this).prop('disabled', true);\n        let reorderItems = getReorderItems();\n        Object.values(reorderItems).forEach(function (item) {\n            let tr = $(elementSelector + ' tr[data-id=\"' + item.id + '\"]');\n            if (tr) {\n                tr.attr('data-depth', item.depth);\n                tr.attr('data-parent', item.parent);\n                tr.attr('data-menuorder', item.menuorder);\n            }\n        });\n        // Check invalid depth\n        let invalidDepth = await checkInvalidDepth();\n        if (invalidDepth) {\n            $(this).prop('disabled', false);\n            return;\n        }\n        // Save the menu items\n        await ajaxSaveMenuItems(reorderItems);\n\n    });\n\n};\n\n\n/**\n *\n * @param {*} rolesByContext\n * @returns\n */\nexport const contextRoleFilter = (rolesByContext) => {\n    const contextSelect = document.querySelector('select[name=\"context_level\"]');\n    const roleSelect = document.querySelector('select[name=\"condition_roleid\"]');\n\n    if (!contextSelect || !roleSelect) {\n        return;\n    }\n\n    contextSelect.addEventListener('change', () => {\n        const ctxValue = contextSelect.value;\n        const roleList = rolesByContext[ctxValue] || [];\n        const previouslySelected = roleSelect.value;\n        roleSelect.innerHTML = '';\n        roleList.forEach(({ value, label }) => {\n            const opt = document.createElement('option');\n            opt.value = value;\n            opt.textContent = label;\n            if (value === previouslySelected) {\n                opt.selected = true;\n            }\n            roleSelect.appendChild(opt);\n        });\n    });\n};\n"],"names":["elementSelector","tableid","childArrow","document","querySelector","innerHTML","childIndentation","SortableList","targetListSelector","moveHandlerSelector","isHorizontal","autoScroll","on","e","preventDefault","stopPropagation","tr","this","closest","depth0Rows","is","first","hasOtherDepth0","length","nextRowDepth","parseInt","next","attr","stopImmediatePropagation","EVENTS","DROP","async","evt","info","element","endX","startX","positionChanged","itemDepth","newItemDepth","prevElement","prev","prevElementDepth","elementIndex","index","targetNextElementDepth","targetNextElement","Math","max","min","childIndentationIcon","indentation","find","html","show","prop","reorderItems","depthStack","parent","each","id","depth","menuorder","getReorderItems","Object","values","forEach","item","invalidRows","removeClass","css","remove","parentId","parentDepth","abs","push","row","addClass","insertAfter","checkInvalidDepth","request","methodname","args","items","Ajax","call","done","response","status","window","location","reload","console","log","message","fail","always","ajaxSaveMenuItems","rolesByContext","contextSelect","roleSelect","addEventListener","ctxValue","value","roleList","previouslySelected","_ref","label","opt","createElement","textContent","selected","appendChild"],"mappings":"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"}