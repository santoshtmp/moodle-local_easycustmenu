{"version":3,"file":"menu_items.min.js","sources":["../src/menu_items.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module\n *\n * @copyright  2025 https://santoshmagar.com.np/\n * @author     santoshtmp7 https://github.com/santoshtmp/moodle-local_easycustmenu\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n *\n */\n\nimport $ from 'jquery';\nimport SortableList from 'core/sortable_list';\nimport Ajax from 'core/ajax';\nimport { getString } from 'core/str';\n\n/**\n * variables define\n */\nlet elementSelector = '';\nlet moveHandlerSelector = '[data-drag-type=move]';\n\n\n/**\n * To check menu items siglings tr depths\n */\nasync function check_invalid_depth() {\n    let prevDepth = 0;\n    let invalidRows = [];\n    $(elementSelector + ' tr').removeClass('invalid-depth').css('background-color', '');\n    $('#menu_depth_error').remove();\n\n    // check on each tr\n    $(elementSelector + ' tr').each(function () {\n        let depth = parseInt($(this).attr('data-depth'));\n        if (Math.abs(depth - prevDepth) > 1) {\n            invalidRows.push($(this));\n        }\n        prevDepth = depth;\n    });\n\n    // check invalid length\n    if (invalidRows.length > 0) {\n        invalidRows.forEach(function (row) {\n            row.addClass('invalid-depth').css('background-color', '#ffcccc'); // light red\n        });\n        $('#save_menu_reorder').prop('disabled', true);\n        $('<div id=\"menu_depth_error\" style=\"color:red;margin-top:10px;\">' +\n            await getString('invalidmenudepth', 'local_easycustmenu') + '</div>')\n            .insertAfter($('#save_menu_reorder'));\n    } else {\n        $('#save_menu_reorder').prop('disabled', false);\n    }\n\n    return invalidRows.length;\n}\n\n/**\n * To save the menu items\n * @param {*} reorder_items\n */\nasync function ajax_save_menu_items(reorder_items) {\n    // AJAX request to save the order\n    const request = {\n        methodname: 'local_easycustmenu_save_menu_order',\n        args: {\n            items: reorder_items,\n        }\n    };\n    return await Ajax.call([request])[0]\n        .done(function (response) {\n            if (response.status) {\n                window.console.log('Menu order saved successfully.');\n                $('#save_menu_reorder').hide();\n            } else {\n                window.console.log('Error saving menu order:', response.message);\n            }\n        }).fail(function () {\n            window.console.log('request failed.');\n        }).always(function () {\n            $('#save_menu_reorder').prop('disabled', false);\n        }\n        );\n}\n\n/**\n * get_reorder_items\n */\nfunction get_reorder_items() {\n    let reorder_items = {};\n    let depthStack = {}; // Stores the last seen ID for each depth level\n    $(elementSelector + ' tr').each(function (index) {\n        let id = parseInt($(this).attr('data-id'));\n        let depth = parseInt($(this).attr('data-depth'));\n\n        // Store the last seen item at this depth\n        depthStack[depth] = id;\n\n        // Determine parent\n        let parent = 0;\n        if (depth > 0) {\n            parent = depthStack[depth - 1] || 0;\n        }\n\n        $(this).attr('data-parent', parent);\n        reorder_items[id] = {\n            menu_order: index,\n            id: id,\n            depth: depth,\n            parent: parent,\n        };\n\n    });\n    return reorder_items;\n}\n\n/**\n * Menu Item Re-order\n *\n * @param {*} tableid\n */\nexport const menu_item_reorder = (tableid) => {\n    //\n    elementSelector = '#' + tableid + ' tbody[data-action=\"reorder\"]';\n\n    // Initialise SortableList for drag-and-drop.\n    new SortableList(\n        elementSelector,\n        {\n            targetListSelector: null,\n            moveHandlerSelector: moveHandlerSelector,\n            isHorizontal: false,\n            autoScroll: true,\n            canMove: (element) => {\n                // Disable drag for first tr with depth 0\n                let depth = parseInt(element.attr('data-depth')) || 0;\n                let isFirst = element.is($(elementSelector + ' tr').first());\n                if (depth === 0 && isFirst) {\n                    return false; // disable drag\n                }\n                return true; // enable drag for others\n            }\n\n        }\n    );\n\n    // Disable click on drag handle to prevent unintended clicks\n    $(elementSelector).on('click', moveHandlerSelector, function (e) {\n        e.preventDefault();\n        e.stopPropagation();\n        return false;\n    });\n\n    // Prevent dragging start for first depth 0\n    $(elementSelector).on('mousedown', moveHandlerSelector, function (e) {\n        let tr = $(this).closest('tr');\n\n        // Find all depth 0 rows\n        let depth0Rows = $(elementSelector + ' tr[data-depth=\"0\"]');\n\n        // Check if this is the first depth 0 row\n        let isFirstDepth0 = tr.is(depth0Rows.first());\n\n        if (isFirstDepth0) {\n            let hasOtherDepth0 = depth0Rows.length > 1;\n            let nextRowDepth = parseInt(tr.next().attr('data-depth')) || 0;\n\n            // Condition: no other depth 0 row OR next sibling has depth > 0\n            if (!hasOtherDepth0 || nextRowDepth > 0) {\n                e.preventDefault();\n                e.stopImmediatePropagation();\n                return false;\n            }\n        }\n    });\n\n    // Handle drag-and-drop depth changes.\n    $(elementSelector).on(SortableList.EVENTS.DROP, async function (evt, info) {\n        let element = info.element;\n        let end_x = info.endX;\n        let start_x = info.startX;\n        let positionChanged = info.positionChanged;\n        let itemDepth = parseInt(element.attr('data-depth')) || 0;\n        let new_itemDepth = itemDepth;\n        let prevElement = element.prev();\n        let prevElementDepth = parseInt(prevElement.attr('data-depth')) || 0;\n\n        // Only adjust depth for significant horizontal movement\n        if (positionChanged) {\n            let elementIndex = $(elementSelector + ' tr').index(element);\n            let targetNextElementDepth = parseInt(info.targetNextElement.attr('data-depth')) || 0;\n            new_itemDepth = (elementIndex == 0) ? 0 : Math.max(prevElementDepth, targetNextElementDepth);\n        } else {\n            if (prevElement.length) {\n                if (end_x > start_x + 30) {\n                    new_itemDepth = Math.min(itemDepth + 1, prevElementDepth + 1);\n                } else if (end_x < start_x - 30) {\n                    new_itemDepth = Math.max(0, itemDepth - 1);\n                }\n            }\n        }\n\n        // Update element depth and indentation only if depth changed\n        if (new_itemDepth !== itemDepth) {\n            element.attr('data-depth', new_itemDepth);\n            let indentation = element.find('.indentation');\n            indentation.css({\n                'width': (30 * new_itemDepth) + 'px'\n            });\n        }\n        //\n        setTimeout(async () => {\n            let reorder_items = get_reorder_items();\n            Object.values(reorder_items).forEach(function (item) {\n                let tr = $(elementSelector + ' tr[data-id=\"' + item.id + '\"]');\n                if (tr) {\n                    tr.attr('data-depth', item.depth);\n                    tr.attr('data-parent', item.parent);\n                    tr.attr('data-menu_order', item.menu_order);\n                }\n            });\n            // check invalid depth\n            await check_invalid_depth();\n        }, 1000);\n\n        // Show save button after reordering\n        $('#save_menu_reorder').show();\n\n    });\n\n    // save the order of menu items\n    $('#save_menu_reorder').on('click', async function () {\n        // check invalid depth\n        let invalid_depth = await check_invalid_depth();\n        if (invalid_depth) {\n            return;\n        }\n        // Disable to prevent multiple clicks\n        $(this).prop('disabled', true);\n        //\n        let reorder_items = get_reorder_items();\n        // save the menu items\n        await ajax_save_menu_items(reorder_items);\n\n    });\n\n};\n\n\n"],"names":["elementSelector","check_invalid_depth","prevDepth","invalidRows","removeClass","css","remove","each","depth","parseInt","this","attr","Math","abs","push","length","forEach","row","addClass","prop","insertAfter","get_reorder_items","reorder_items","depthStack","index","id","parent","menu_order","tableid","SortableList","targetListSelector","moveHandlerSelector","isHorizontal","autoScroll","canMove","element","isFirst","is","first","on","e","preventDefault","stopPropagation","tr","closest","depth0Rows","hasOtherDepth0","nextRowDepth","next","stopImmediatePropagation","EVENTS","DROP","async","evt","info","end_x","endX","start_x","startX","positionChanged","itemDepth","new_itemDepth","prevElement","prev","prevElementDepth","elementIndex","targetNextElementDepth","targetNextElement","max","min","find","setTimeout","Object","values","item","show","request","methodname","args","items","Ajax","call","done","response","status","window","console","log","hide","message","fail","always","ajax_save_menu_items"],"mappings":"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"}