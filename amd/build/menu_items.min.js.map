{"version":3,"file":"menu_items.min.js","sources":["../src/menu_items.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD ES6 module\n *\n * @copyright  2025 https://santoshmagar.com.np/\n * @author     santoshtmp7 https://github.com/santoshtmp/moodle-local_easycustmenu\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n *\n */\n\nimport $ from 'jquery';\nimport SortableList from 'core/sortable_list';\nimport Ajax from 'core/ajax';\nimport { getString } from 'core/str';\n\n/**\n * variables define\n */\nlet elementSelector = '';\nlet moveHandlerSelector = '[data-drag-type=move]';\n\n\n/**\n * To check menu items siglings tr depths\n */\nasync function check_invalid_depth() {\n    let invalidRows = [];\n    $(elementSelector + ' tr').removeClass('invalid-depth').css('background-color', '');\n    $('#menu_depth_error').remove();\n\n    // check on each tr\n    $(elementSelector + ' tr').each(function () {\n        let depth = parseInt($(this).attr('data-depth')) || 0;\n        let parent_id = parseInt($(this).attr('data-parent'));\n        let parent_depth = $(elementSelector + ' tr[data-id=\"' + parent_id + '\"]').attr('data-depth') || 0;\n        if (Math.abs(depth - parseInt(parent_depth)) > 1) {\n            invalidRows.push($(this));\n        }\n    });\n\n    // check invalid length\n    if (invalidRows.length > 0) {\n        invalidRows.forEach(function (row) {\n            row.addClass('invalid-depth').css('background-color', '#ffcccc'); // light red\n        });\n        $('#save_menu_reorder').prop('disabled', true);\n        $('<div id=\"menu_depth_error\" style=\"color:red;margin-top:10px;\">' +\n            await getString('invalidmenudepth', 'local_easycustmenu') + '</div>')\n            .insertAfter($('#save_menu_reorder'));\n    } else {\n        $('#save_menu_reorder').prop('disabled', false);\n    }\n\n    return invalidRows.length;\n}\n\n/**\n * To save the menu items\n * @param {*} reorder_items\n */\nasync function ajax_save_menu_items(reorder_items) {\n    // AJAX request to save the order\n    const request = {\n        methodname: 'local_easycustmenu_save_menu_order',\n        args: {\n            items: reorder_items,\n        }\n    };\n    return await Ajax.call([request])[0]\n        .done(function (response) {\n            if (response.status) {\n                window.location.reload();\n                // window.console.log('Menu order saved successfully.');\n                // $('#save_menu_reorder').hide();\n            } else {\n                window.console.log('Error saving menu order:', response.message);\n            }\n        }).fail(function () {\n            window.console.log('request failed.');\n        }).always(function () {\n            $('#save_menu_reorder').prop('disabled', false);\n        }\n        );\n}\n\n/**\n * get_reorder_items\n */\nfunction get_reorder_items() {\n    let reorder_items = {};\n    let depthStack = {}; // Stores the last seen ID for each depth level\n    let parent = 0;\n    $(elementSelector + ' tr').each(function (index) {\n        let id = parseInt($(this).attr('data-id'));\n        let depth = parseInt($(this).attr('data-depth')) || 0;\n        // Determine parent\n        if (depth > 0) {\n            parent = depthStack[depth - 1] || 0;\n        } else {\n            depthStack = {};\n            parent = 0;\n        }\n        // Store the last seen item at this depth\n        depthStack[depth] = id;\n        //\n        $(this).attr('data-parent', parent);\n        reorder_items[id] = {\n            menu_order: index,\n            id: id,\n            depth: depth,\n            parent: parent,\n        };\n\n    });\n    return reorder_items;\n}\n\n/**\n * Menu Item Re-order\n *\n * @param {*} tableid\n */\nexport const menu_item_reorder = (tableid) => {\n    //\n    elementSelector = '#' + tableid + ' tbody[data-action=\"reorder\"]';\n    let child_arrow = document.querySelector('#depth-reusable-icon #child_arrow').innerHTML;\n    let child_indentation = document.querySelector('#depth-reusable-icon #child_indentation').innerHTML;\n\n    // Initialise SortableList for drag-and-drop.\n    new SortableList(\n        elementSelector,\n        {\n            targetListSelector: null,\n            moveHandlerSelector: moveHandlerSelector,\n            isHorizontal: false,\n            autoScroll: true\n        }\n    );\n\n    // Disable click on drag handle to prevent unintended clicks\n    $(elementSelector).on('click', moveHandlerSelector, function (e) {\n        e.preventDefault();\n        e.stopPropagation();\n        return false;\n    });\n\n    // Prevent dragging start for first depth 0\n    $(elementSelector).on('mousedown', moveHandlerSelector, function (e) {\n        let tr = $(this).closest('tr');\n\n        // Find all depth 0 rows\n        let depth0Rows = $(elementSelector + ' tr[data-depth=\"0\"]');\n\n        // Check if this is the first depth 0 row\n        let isFirstDepth0 = tr.is(depth0Rows.first());\n\n        if (isFirstDepth0) {\n            let hasOtherDepth0 = depth0Rows.length > 1;\n            let nextRowDepth = parseInt(tr.next().attr('data-depth')) || 0;\n\n            // Condition: no other depth 0 row OR next sibling has depth > 0\n            if (!hasOtherDepth0 || nextRowDepth > 0) {\n                e.preventDefault();\n                e.stopImmediatePropagation();\n                return false;\n            }\n        }\n    });\n\n    // Handle drag-and-drop depth changes.\n    $(elementSelector).on(SortableList.EVENTS.DROP, async function (evt, info) {\n        if (tableid == 'navmenu-table') {\n            let element = info.element;\n            let end_x = info.endX;\n            let start_x = info.startX;\n            let positionChanged = info.positionChanged;\n            let itemDepth = parseInt(element.attr('data-depth')) || 0;\n            let new_itemDepth = itemDepth;\n            let prevElement = element.prev();\n            let prevElementDepth = parseInt(prevElement.attr('data-depth')) || 0;\n\n            // Only adjust depth for significant horizontal movement\n            if (positionChanged) {\n                let elementIndex = $(elementSelector + ' tr').index(element);\n                let targetNextElementDepth = parseInt(info.targetNextElement.attr('data-depth')) || 0;\n                new_itemDepth = (elementIndex == 0) ? 0 : Math.max(prevElementDepth, targetNextElementDepth);\n            } else {\n                if (prevElement.length) {\n                    if (end_x > start_x + 30) {\n                        new_itemDepth = Math.min(itemDepth + 1, prevElementDepth + 1);\n                    } else if (end_x < start_x - 30) {\n                        new_itemDepth = Math.max(0, itemDepth - 1);\n                    }\n                }\n            }\n\n            // Update element depth and child-icon only if depth changed\n            if (new_itemDepth !== itemDepth) {\n                element.attr('data-depth', new_itemDepth);\n                let child_indentation_icon = '';\n                if (new_itemDepth) {\n                    for (let index = 0; index < new_itemDepth - 1; index++) {\n                        child_indentation_icon += child_indentation;\n                    }\n                    child_indentation_icon += child_arrow;\n                }\n                let indentation = element.find('.child-icon-wrapper');\n                if (indentation) {\n                    indentation.html(child_indentation_icon);\n                }\n\n            }\n        }\n        // Show save button after reordering\n        $('#save_menu_reorder').show();\n\n    });\n\n    // save the order of menu items\n    $('#save_menu_reorder').on('click', async function () {\n        // Disable to prevent multiple clicks\n        $(this).prop('disabled', true);\n        //\n        let reorder_items = get_reorder_items();\n        Object.values(reorder_items).forEach(function (item) {\n            let tr = $(elementSelector + ' tr[data-id=\"' + item.id + '\"]');\n            if (tr) {\n                tr.attr('data-depth', item.depth);\n                tr.attr('data-parent', item.parent);\n                tr.attr('data-menu_order', item.menu_order);\n            }\n        });\n        // check invalid depth\n        let invalid_depth = await check_invalid_depth();\n        if (invalid_depth) {\n            $(this).prop('disabled', false);\n            return;\n        }\n        // save the menu items\n        await ajax_save_menu_items(reorder_items);\n\n    });\n\n};\n\n\n/**\n *\n * @param {*} rolesByContext\n * @returns\n */\nexport const context_role_filter = (rolesByContext) => {\n    const contextSelect = document.querySelector('select[name=\"context_level\"]');\n    const roleSelect = document.querySelector('select[name=\"condition_roleid\"]');\n\n    if (!contextSelect || !roleSelect) {\n        return;\n    }\n\n    contextSelect.addEventListener('change', () => {\n        const ctxValue = contextSelect.value;\n        const roleList = rolesByContext[ctxValue] || [];\n        const previouslySelected = roleSelect.value;\n        roleSelect.innerHTML = '';\n        roleList.forEach(({ value, label }) => {\n            const opt = document.createElement('option');\n            opt.value = value;\n            opt.textContent = label;\n            if (value === previouslySelected) {\n                opt.selected = true;\n            }\n            roleSelect.appendChild(opt);\n        });\n    });\n};\n"],"names":["elementSelector","tableid","child_arrow","document","querySelector","innerHTML","child_indentation","SortableList","targetListSelector","moveHandlerSelector","isHorizontal","autoScroll","on","e","preventDefault","stopPropagation","tr","this","closest","depth0Rows","is","first","hasOtherDepth0","length","nextRowDepth","parseInt","next","attr","stopImmediatePropagation","EVENTS","DROP","async","evt","info","element","end_x","endX","start_x","startX","positionChanged","itemDepth","new_itemDepth","prevElement","prev","prevElementDepth","elementIndex","index","targetNextElementDepth","targetNextElement","Math","max","min","child_indentation_icon","indentation","find","html","show","prop","reorder_items","depthStack","parent","each","id","depth","menu_order","get_reorder_items","Object","values","forEach","item","invalidRows","removeClass","css","remove","parent_id","parent_depth","abs","push","row","addClass","insertAfter","check_invalid_depth","request","methodname","args","items","Ajax","call","done","response","status","window","location","reload","console","log","message","fail","always","ajax_save_menu_items","rolesByContext","contextSelect","roleSelect","addEventListener","ctxValue","value","roleList","previouslySelected","_ref","label","opt","createElement","textContent","selected","appendChild"],"mappings":"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"}